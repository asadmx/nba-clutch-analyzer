<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Results • Clutch Rating Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Modern font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --app-bg: #0b1220;
            --app-card: rgba(255,255,255,.07);
            --app-card-2: rgba(255,255,255,.10);
            --app-border: rgba(255,255,255,.12);
            --app-text: rgba(255,255,255,.92);
            --app-muted: rgba(255,255,255,.65);

            --app-accent: #7c5cff;
            --app-accent-2: #22c55e;

            --app-shadow: 0 18px 50px rgba(0,0,0,.35);
            --app-radius: 18px;
        }

        body{
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background:
                    radial-gradient(1200px 500px at 15% -10%, rgba(124,92,255,0.35), transparent 60%),
                    radial-gradient(900px 450px at 85% 0%, rgba(34,197,94,0.22), transparent 55%),
                    radial-gradient(800px 520px at 50% 110%, rgba(124,92,255,0.18), transparent 60%),
                    var(--app-bg);
            color: var(--app-text);
        }

        .app-container { max-width: 1100px; }

        .app-card{
            background: linear-gradient(180deg, var(--app-card), rgba(255,255,255,.03));
            border: 1px solid var(--app-border) !important;
            border-radius: var(--app-radius) !important;
            box-shadow: var(--app-shadow);
        }

        .app-card-header{
            background: linear-gradient(180deg, var(--app-card-2), var(--app-card));
            border-bottom: 1px solid var(--app-border) !important;
        }

        .text-muted { color: var(--app-muted) !important; }

        .team-logo {
            height: 44px;
            width: 44px;
            object-fit: contain;
        }

        .logo-chip{
            border: 1px solid var(--app-border);
            background: rgba(255,255,255,.06);
            border-radius: 14px;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .badge-soft{
            background: rgba(124,92,255,.18);
            border: 1px solid rgba(124,92,255,.35);
            color: rgba(255,255,255,.92);
        }

        .btn-accent{
            background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.72));
            border: 1px solid rgba(124,92,255,.65);
            color: #fff;
        }
        .btn-accent:hover{
            background: linear-gradient(135deg, rgba(124,92,255,1), rgba(124,92,255,.78));
            color: #fff;
        }

        /* Segmented toggle */
        .segmented .btn{ border-color: var(--app-border) !important; }
        .segmented .btn-check:checked + .btn{
            background: rgba(124,92,255,.22) !important;
            border-color: rgba(124,92,255,.55) !important;
            color: #fff !important;
        }

        /* Table polish */
        .table{
            --bs-table-bg: transparent;
            --bs-table-color: rgba(255,255,255,.90);
            --bs-table-hover-color: #fff;
            --bs-table-hover-bg: rgba(124,92,255,.10);
            margin-bottom: 0;
        }
        .table thead th{
            color: rgba(255,255,255,.70);
            font-weight: 700;
            letter-spacing: .06em;
            text-transform: uppercase;
            font-size: 12px;
            border-bottom: 1px solid var(--app-border) !important;
            background: rgba(255,255,255,.05);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .table tbody td{
            border-bottom: 1px solid rgba(255,255,255,.07) !important;
            vertical-align: middle;
            font-variant-numeric: tabular-nums;
        }

        .rating-pill{
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(124,92,255,.18);
            border: 1px solid rgba(124,92,255,.35);
            font-weight: 800;
        }

        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Sticky action bar */
        .sticky-actions{
            position: sticky;
            top: 12px;
            z-index: 50;
            border: 1px solid var(--app-border);
            background: rgba(15, 23, 42, .65);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        /* Make Bootstrap inputs readable on dark glass */
        .sticky-actions .form-control,
        .sticky-actions .form-select{
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.14);
            color: rgba(255,255,255,.92);
        }
        .sticky-actions .form-control::placeholder{
            color: rgba(255,255,255,.55);
        }
        .sticky-actions .form-control:focus,
        .sticky-actions .form-select:focus{
            border-color: rgba(124,92,255,.70);
            box-shadow: 0 0 0 .25rem rgba(124,92,255,.18);
            background: rgba(255,255,255,.08);
            color: rgba(255,255,255,.95);
        }

        /* ✅ Fix unreadable dropdown options */
        .sticky-actions select option,
        .sticky-actions select optgroup{
            background: #0b1220;
            color: rgba(255,255,255,.92);
        }

        @media (max-width: 720px){
            .stack-sm { flex-direction: column !important; align-items: stretch !important; }
            .w-sm-100 { width: 100% !important; }
        }
    </style>
</head>

<body>
<div class="container app-container py-4 py-md-5">

    <!-- Top bar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <span class="rounded-circle" style="width:10px;height:10px;background:linear-gradient(135deg,var(--app-accent),var(--app-accent-2));box-shadow:0 0 0 6px rgba(124,92,255,.14);"></span>
            <span class="fw-semibold text-muted">Clutch Rating Analyzer</span>
        </div>
        <a href="/" class="btn btn-outline-light btn-sm">New Upload</a>
    </div>

    <!-- HERO / HEADER -->
    <div class="app-card p-3 p-md-4 mb-3">
        <div class="d-flex justify-content-between align-items-start gap-3 stack-sm">
            <div class="w-100">
                <h1 class="h4 fw-bold mb-1">Clutch Leaderboard</h1>

                <!-- NBA matchup + date + logos + FINAL SCORE -->
                <div class="text-muted d-flex flex-wrap align-items-center gap-2 mt-2" th:if="${isNbaMode}">

                    <span class="logo-chip"
                          th:if="${awayLogoUrl != null and !#strings.isEmpty(awayLogoUrl)}">
                        <img class="team-logo"
                             th:src="${awayLogoUrl}"
                             alt="Away logo"
                             onerror="this.style.display='none'">
                    </span>

                    <span class="fw-semibold text-white" th:text="${awayTeam}"></span>
                    <span class="text-muted"> @ </span>
                    <span class="fw-semibold text-white" th:text="${homeTeam}"></span>

                    <span class="logo-chip"
                          th:if="${homeLogoUrl != null and !#strings.isEmpty(homeLogoUrl)}">
                        <img class="team-logo"
                             th:src="${homeLogoUrl}"
                             alt="Home logo"
                             onerror="this.style.display='none'">
                    </span>

                    <span class="badge rounded-pill badge-soft"
                          th:if="${gameDate != null and !#strings.isEmpty(gameDate)}"
                          th:text="${gameDate}"></span>

                    <!-- Final score + FT/OT label -->
                    <span class="badge rounded-pill badge-soft"
                          th:if="${awayScore != null and homeScore != null}">
                        Final:
                        <span class="fw-semibold" th:text="${awayScore}"></span>
                        -
                        <span class="fw-semibold" th:text="${homeScore}"></span>
                        <span th:if="${timeLabel != null}">
                            (<span th:text="${timeLabel}"></span>)
                        </span>
                    </span>
                </div>

                <!-- Non-NBA (team lookup) header -->
                <div class="text-muted mt-2" th:if="${!isNbaMode}">
                    Team input: <span class="fw-semibold text-white" th:text="${teamQuery}"></span>
                </div>

                <!-- Window label -->
                <div class="text-muted small mt-2" th:if="${clutchSeconds != null}">
                    Window:
                    <span class="fw-semibold text-white"
                          th:text="${clutchSeconds == 300 ? 'Last 5:00' : (clutchSeconds == 120 ? 'Last 2:00' : 'Custom (' + clutchSeconds + 's)')}">
                    </span>

                    <span class="badge rounded-pill badge-soft ms-2"
                          th:if="${closePoints != null}"
                          th:text="${'Close: ≤' + closePoints}">
                    </span>

                    <span class="ms-2 mono small">
                        ClutchRating = PTS + AST + 2×STL + 2×BLK − 2×TOV − MissedFG − MissedFT
                    </span>
                </div>
            </div>

            <a href="/" class="btn btn-accent w-sm-100">Analyze Another</a>
        </div>
    </div>

    <!-- Sticky action bar (toggle + close filter + copy link + search) -->
    <div class="sticky-actions p-2 p-md-3 mb-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

            <!-- Left: Toggle (only when NBA + 2/5) -->
            <div th:if="${isNbaMode and clutchSeconds != null and (clutchSeconds == 300 or clutchSeconds == 120)}">
                <div class="btn-group segmented" role="group" aria-label="Clutch window toggle">
                    <input type="radio" class="btn-check" name="windowToggle" id="btn5"
                           autocomplete="off" checked onclick="showWindow('5')">
                    <label class="btn btn-outline-light btn-sm" for="btn5">Last 5 min</label>

                    <input type="radio" class="btn-check" name="windowToggle" id="btn2"
                           autocomplete="off" onclick="showWindow('2')">
                    <label class="btn btn-outline-light btn-sm" for="btn2">Last 2 min</label>
                </div>
            </div>

            <!-- NEW: Close game filter -->
            <div style="min-width: 160px;" th:if="${isNbaMode}">
                <select id="closePointsSelect" class="form-select form-select-sm" onchange="applyCloseFilter()">
                    <option value="" th:selected="${closePoints == null}">Close: Any</option>
                    <option value="10" th:selected="${closePoints != null and closePoints == 10}">Close: ≤10</option>
                    <option value="7"  th:selected="${closePoints != null and closePoints == 7}">Close: ≤7</option>
                    <option value="5"  th:selected="${closePoints != null and closePoints == 5}">Close: ≤5</option>
                    <option value="3"  th:selected="${closePoints != null and closePoints == 3}">Close: ≤3</option>
                </select>
            </div>

            <!-- Middle: Search -->
            <div class="flex-grow-1" style="min-width: 220px;">
                <input id="tableSearch" class="form-control form-control-sm"
                       placeholder="Search player or team (e.g., Durant, HOU) …">
            </div>

            <!-- Right: Actions -->
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-light btn-sm" onclick="copyLink()">Copy Link</button>
            </div>
        </div>

        <div class="text-muted small mt-2">
            Tip: Close filter applies to what counts as “clutch”. Search filters visible rows only.
        </div>
    </div>

    <!-- CONTENT -->

    <!-- NBA invalid gameId warning -->
    <div class="alert alert-warning border-0"
         style="background: rgba(245,158,11,.16); color: rgba(255,214,140,.95);"
         th:if="${isNbaMode and ((leaderboard5 == null or #lists.isEmpty(leaderboard5)) and (leaderboard2 == null or #lists.isEmpty(leaderboard2)) and (leaderboard == null or #lists.isEmpty(leaderboard)))}">
        No NBA play-by-play data returned for this gameId. Try another NBA id.
    </div>

    <!-- TheSportsDB team card ONLY for non-NBA mode -->
    <div class="app-card mb-3" th:if="${!isNbaMode and teamInfo != null}">
        <div class="app-card-header p-3">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <img th:src="${teamInfo.get('strBadge')}" alt="Team logo"
                     style="height:56px;width:56px;object-fit:contain;"
                     onerror="this.style.display='none'">
                <div>
                    <div class="fw-bold" th:text="${teamInfo.get('strTeam')}"></div>
                    <div class="text-muted small">
                        <span th:text="${teamInfo.get('strLeague')}"></span>
                        <span th:if="${teamInfo.get('strStadium') != null}"> • </span>
                        <span th:text="${teamInfo.get('strStadium')}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team lookup warning ONLY for non-NBA mode -->
    <div class="alert alert-warning"
         th:if="${!isNbaMode and teamInfo == null}">
        Could not find team info for "<span class="fw-semibold" th:text="${teamQuery}"></span>".
        Try a different team name.
    </div>

    <!-- CUSTOM window: single-table behavior -->
    <div id="tableCustom" th:if="${clutchSeconds != null and clutchSeconds != 300 and clutchSeconds != 120}">
        <div class="app-card" th:if="${leaderboard != null and !#lists.isEmpty(leaderboard)}">
            <div class="app-card-header p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="fw-bold">Custom Window</div>
                <span class="badge rounded-pill badge-soft" th:text="${clutchSeconds + 's'}"></span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th style="width:70px;">Rank</th>
                        <th>Player</th>
                        <th style="width:90px;" class="text-end">PTS</th>
                        <th style="width:160px;">Clutch Rating</th>
                        <th style="width:80px;" class="text-end">FGM</th>
                        <th style="width:80px;" class="text-end">FGA</th>
                        <th style="width:80px;" class="text-end">FTM</th>
                        <th style="width:80px;" class="text-end">FTA</th>
                        <th style="width:80px;" class="text-end">AST</th>
                        <th style="width:80px;" class="text-end">STL</th>
                        <th style="width:80px;" class="text-end">BLK</th>
                        <th style="width:80px;" class="text-end">TOV</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, i : ${leaderboard}" class="result-row">
                        <td class="fw-semibold text-muted" th:text="${i.index + 1}"></td>
                        <td class="fw-semibold" th:text="${p.displayName()}"></td>
                        <td class="text-end fw-bold" th:text="${p.points}"></td>
                        <td><span class="rating-pill" th:text="${p.clutchRating()}"></span></td>
                        <td class="text-end" th:text="${p.fgm}"></td>
                        <td class="text-end" th:text="${p.fga}"></td>
                        <td class="text-end" th:text="${p.ftm}"></td>
                        <td class="text-end" th:text="${p.fta}"></td>
                        <td class="text-end" th:text="${p.ast}"></td>
                        <td class="text-end" th:text="${p.stl}"></td>
                        <td class="text-end" th:text="${p.blk}"></td>
                        <td class="text-end" th:text="${p.tov}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- NBA 5-min table -->
    <div id="table5" th:if="${leaderboard5 != null and !#lists.isEmpty(leaderboard5)}">
        <div class="app-card">
            <div class="app-card-header p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="fw-bold">Last 5 minutes</div>
                <span class="badge rounded-pill badge-soft">5:00</span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th style="width:70px;">Rank</th>
                        <th>Player</th>
                        <th style="width:90px;" class="text-end">PTS</th>
                        <th style="width:160px;">Clutch Rating</th>
                        <th style="width:80px;" class="text-end">FGM</th>
                        <th style="width:80px;" class="text-end">FGA</th>
                        <th style="width:80px;" class="text-end">FTM</th>
                        <th style="width:80px;" class="text-end">FTA</th>
                        <th style="width:80px;" class="text-end">AST</th>
                        <th style="width:80px;" class="text-end">STL</th>
                        <th style="width:80px;" class="text-end">BLK</th>
                        <th style="width:80px;" class="text-end">TOV</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, i : ${leaderboard5}" class="result-row">
                        <td class="fw-semibold text-muted" th:text="${i.index + 1}"></td>
                        <td class="fw-semibold" th:text="${p.displayName()}"></td>
                        <td class="text-end fw-bold" th:text="${p.points}"></td>
                        <td><span class="rating-pill" th:text="${p.clutchRating()}"></span></td>
                        <td class="text-end" th:text="${p.fgm}"></td>
                        <td class="text-end" th:text="${p.fga}"></td>
                        <td class="text-end" th:text="${p.ftm}"></td>
                        <td class="text-end" th:text="${p.fta}"></td>
                        <td class="text-end" th:text="${p.ast}"></td>
                        <td class="text-end" th:text="${p.stl}"></td>
                        <td class="text-end" th:text="${p.blk}"></td>
                        <td class="text-end" th:text="${p.tov}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- NBA 2-min table -->
    <div id="table2" style="display:none;" th:if="${leaderboard2 != null and !#lists.isEmpty(leaderboard2)}">
        <div class="app-card">
            <div class="app-card-header p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="fw-bold">Last 2 minutes</div>
                <span class="badge rounded-pill badge-soft">2:00</span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th style="width:70px;">Rank</th>
                        <th>Player</th>
                        <th style="width:90px;" class="text-end">PTS</th>
                        <th style="width:160px;">Clutch Rating</th>
                        <th style="width:80px;" class="text-end">FGM</th>
                        <th style="width:80px;" class="text-end">FGA</th>
                        <th style="width:80px;" class="text-end">FTM</th>
                        <th style="width:80px;" class="text-end">FTA</th>
                        <th style="width:80px;" class="text-end">AST</th>
                        <th style="width:80px;" class="text-end">STL</th>
                        <th style="width:80px;" class="text-end">BLK</th>
                        <th style="width:80px;" class="text-end">TOV</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, i : ${leaderboard2}" class="result-row">
                        <td class="fw-semibold text-muted" th:text="${i.index + 1}"></td>
                        <td class="fw-semibold" th:text="${p.displayName()}"></td>
                        <td class="text-end fw-bold" th:text="${p.points}"></td>
                        <td><span class="rating-pill" th:text="${p.clutchRating()}"></span></td>
                        <td class="text-end" th:text="${p.fgm}"></td>
                        <td class="text-end" th:text="${p.fga}"></td>
                        <td class="text-end" th:text="${p.ftm}"></td>
                        <td class="text-end" th:text="${p.fta}"></td>
                        <td class="text-end" th:text="${p.ast}"></td>
                        <td class="text-end" th:text="${p.stl}"></td>
                        <td class="text-end" th:text="${p.blk}"></td>
                        <td class="text-end" th:text="${p.tov}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
            <div class="d-flex">
                <div id="toastBody" class="toast-body">Copied</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showWindow(w) {
        const t5 = document.getElementById("table5");
        const t2 = document.getElementById("table2");

        if (t5) t5.style.display = (w === "5") ? "block" : "none";
        if (t2) t2.style.display = (w === "2") ? "block" : "none";

        // keep radios in sync
        const r5 = document.getElementById("btn5");
        const r2 = document.getElementById("btn2");
        if (r5 && r2) {
            r5.checked = (w === "5");
            r2.checked = (w === "2");
        }
    }

    (function initToggle() {
        const clutchSeconds = /*[[${clutchSeconds}]]*/ 300;
        if (clutchSeconds === 120) showWindow("2");
        else showWindow("5");
    })();

    // Copy link + toast
    function toast(msg) {
        const body = document.getElementById("toastBody");
        const el = document.getElementById("toast");
        body.textContent = msg;
        bootstrap.Toast.getOrCreateInstance(el, { delay: 1600 }).show();
    }

    async function copyLink() {
        const url = window.location.href;
        try {
            await navigator.clipboard.writeText(url);
            toast("Link copied ✅");
        } catch (e) {
            const ta = document.createElement("textarea");
            ta.value = url;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            toast("Link copied ✅");
        }
    }

    // NEW: Apply close filter by rewriting the URL param (keeps gameId/clutchSeconds)
    function applyCloseFilter() {
        const sel = document.getElementById("closePointsSelect");
        if (!sel) return;

        const v = (sel.value || "").trim(); // "" means Any
        const url = new URL(window.location.href);

        if (v === "") url.searchParams.delete("closePoints");
        else url.searchParams.set("closePoints", v);

        // preserve clutchSeconds if present (important for custom)
        if (!url.searchParams.get("clutchSeconds")) {
            const clutchSeconds = /*[[${clutchSeconds}]]*/ 300;
            url.searchParams.set("clutchSeconds", String(clutchSeconds));
        }

        window.location.href = url.toString();
    }

    // Search filter across visible table rows
    function filterRows() {
        const q = (document.getElementById("tableSearch").value || "").trim().toLowerCase();

        // Only filter rows in visible table (5, 2, or custom)
        const candidates = [
            document.getElementById("tableCustom"),
            document.getElementById("table5"),
            document.getElementById("table2")
        ].filter(Boolean);

        const visibleContainer = candidates.find(el => el.style.display !== "none") || candidates[0];
        if (!visibleContainer) return;

        const rows = visibleContainer.querySelectorAll("tr.result-row");
        rows.forEach(r => {
            const text = r.innerText.toLowerCase();
            r.style.display = text.includes(q) ? "" : "none";
        });
    }

    document.getElementById("tableSearch").addEventListener("input", filterRows);

    // When toggling, re-apply search to new visible table
    const _showWindow = window.showWindow;
    window.showWindow = function(w){
        _showWindow(w);
        filterRows();
        const target = document.getElementById(w === "5" ? "table5" : "table2");
        if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
    };
</script>

</body>
</html>
