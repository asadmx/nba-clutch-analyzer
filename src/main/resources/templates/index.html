<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clutch Rating Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Modern font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --app-bg: #0b1220;
            --app-card: rgba(255,255,255,.07);
            --app-card-2: rgba(255,255,255,.10);
            --app-border: rgba(255,255,255,.12);
            --app-text: rgba(255,255,255,.92);
            --app-muted: rgba(255,255,255,.65);

            --app-accent: #7c5cff;
            --app-accent-2: #22c55e;

            --app-radius: 18px;
            --app-shadow: 0 18px 50px rgba(0,0,0,.35);
        }

        body{
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background:
                radial-gradient(1200px 520px at 15% -10%, rgba(124,92,255,0.35), transparent 60%),
                radial-gradient(900px 450px at 85% 0%, rgba(34,197,94,0.22), transparent 55%),
                radial-gradient(800px 520px at 50% 110%, rgba(124,92,255,0.18), transparent 60%),
                var(--app-bg);
            color: var(--app-text);
        }

        .app-container { max-width: 920px; }

        .app-top{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            margin-bottom: 14px;
        }
        .brand{
            display:flex;
            align-items:center;
            gap:10px;
            min-width: 0;
        }
        .brand-dot{
            width: 10px; height: 10px; border-radius: 999px;
            background: linear-gradient(135deg, var(--app-accent), var(--app-accent-2));
            box-shadow: 0 0 0 6px rgba(124,92,255,.14);
        }
        .brand-name{
            font-weight: 700;
            letter-spacing: -0.02em;
            color: rgba(255,255,255,.80);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .app-card{
            background: linear-gradient(180deg, var(--app-card), rgba(255,255,255,.03));
            border: 1px solid var(--app-border) !important;
            border-radius: var(--app-radius) !important;
            box-shadow: var(--app-shadow);
        }

        .app-card-header{
            background: linear-gradient(180deg, var(--app-card-2), var(--app-card));
            border-bottom: 1px solid var(--app-border) !important;
        }

        .text-muted { color: var(--app-muted) !important; }

        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .badge-soft{
            background: rgba(124,92,255,.18);
            border: 1px solid rgba(124,92,255,.35);
            color: rgba(255,255,255,.92);
        }

        .btn-accent{
            background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.72));
            border: 1px solid rgba(124,92,255,.65);
            color: #fff;
        }
        .btn-accent:hover{
            background: linear-gradient(135deg, rgba(124,92,255,1), rgba(124,92,255,.78));
            color: #fff;
        }

        .form-control, .form-select{
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.14);
            color: rgba(255,255,255,.92);
        }
        .form-control::placeholder{ color: rgba(255,255,255,.55); }
        .form-control:focus, .form-select:focus{
            border-color: rgba(124,92,255,.70);
            box-shadow: 0 0 0 .25rem rgba(124,92,255,.18);
            background: rgba(255,255,255,.08);
            color: rgba(255,255,255,.95);
        }
        .form-text{ color: rgba(255,255,255,.55) !important; }

        /* Make file input button nicer on dark */
        input[type="file"]::file-selector-button{
            background: rgba(255,255,255,.10);
            border: 1px solid rgba(255,255,255,.14);
            color: rgba(255,255,255,.88);
            border-radius: 10px;
            padding: 8px 12px;
            margin-right: 10px;
        }
        input[type="file"]::file-selector-button:hover{
            background: rgba(255,255,255,.14);
        }

        @media (max-width: 720px){
            .w-sm-100{ width: 100% !important; }
        }
    </style>
</head>

<body>
<div class="container app-container py-4 py-md-5">

    <!-- Top bar -->
    <div class="app-top">
        <div class="brand">
            <span class="brand-dot"></span>
            <span class="brand-name">Clutch Rating Analyzer</span>
            <span class="badge rounded-pill badge-soft d-none d-sm-inline">Bootstrap UI</span>
        </div>
        <a class="btn btn-outline-light btn-sm" href="/" type="button">Reset</a>
    </div>

    <!-- Hero intro -->
    <div class="app-card p-3 p-md-4 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
            <div class="flex-grow-1">
                <h1 class="h3 fw-bold mb-1">Analyze NBA clutch performance</h1>
                <p class="text-muted mb-0">
                    Upload a CSV or pull a real NBA game by <span class="mono">gameId</span>.
                    Get leaderboards for 5-min, 2-min, or any custom clutch window.
                </p>

                <!-- Links -->
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <a class="btn btn-outline-light btn-sm" href="/nba/clutchest">
                        View Clutchest Games
                    </a>

                    <!-- NEW: Clutchest Player Games -->
                    <a class="btn btn-outline-light btn-sm" href="/nba/clutchplayers?days=0&top=50">
                        Clutchest Player Games
                    </a>

                    <a class="btn btn-outline-light btn-sm" href="/gameids.html" target="_blank">
                        Find Game IDs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV MODE -->
    <div class="app-card mb-4">
        <div class="app-card-header p-3 p-md-4">
            <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                <div>
                    <div class="h5 fw-bold mb-1">CSV Upload Mode</div>
                    <div class="text-muted small">Upload a game log CSV to generate a clutch-time leaderboard.</div>
                </div>
                <span class="badge rounded-pill badge-soft">/analyze</span>
            </div>
        </div>

        <div class="p-3 p-md-4">
            <form method="post" action="/analyze" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Game Log CSV</label>
                    <input type="file" class="form-control" name="file" required>
                    <div class="form-text">
                        Expected columns: <span class="mono">date,game_id,team,player,quarter,clock,event</span>
                    </div>
                </div>

                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Clutch Window</label>
                        <select class="form-select" name="clutchSeconds" id="csvClutchSelect">
                            <option value="300" selected>Last 5:00</option>
                            <option value="120">Last 2:00</option>
                            <option value="custom">Custom…</option>
                        </select>
                    </div>

                    <div class="col-md-3" id="csvCustomWrap" style="display:none;">
                        <label class="form-label fw-semibold">Custom (sec)</label>
                        <input type="number" class="form-control" id="csvCustomSeconds" min="1" max="720" placeholder="e.g. 180">
                        <div class="form-text">1–720 seconds</div>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Team Name (API Lookup)</label>
                        <input class="form-control" name="teamQuery" value="Toronto Raptors">
                        <div class="form-text">Used only for team card info in CSV mode.</div>
                    </div>
                </div>

                <div class="mt-4 d-flex gap-2 flex-wrap">
                    <button class="btn btn-accent">Analyze CSV</button>
                    <a class="btn btn-outline-light" href="/" type="button">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <!-- NBA MODE -->
    <div class="app-card">
        <div class="app-card-header p-3 p-md-4">
            <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                <div>
                    <div class="h5 fw-bold mb-1">NBA Live Mode</div>
                    <div class="text-muted small">
                        Enter a real NBA <span class="mono">gameId</span> or pick from the most recent games.
                    </div>
                </div>
                <span class="badge rounded-pill badge-soft">/nba/game</span>
            </div>
        </div>

        <div class="p-3 p-md-4">

            <!-- Tabs -->
            <ul class="nav nav-pills mb-3" id="nbaTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-enter-btn" data-bs-toggle="pill"
                            data-bs-target="#tab-enter" type="button" role="tab">
                        Enter gameId
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-recent-btn" data-bs-toggle="pill"
                            data-bs-target="#tab-recent" type="button" role="tab">
                        Recent (Top 50)
                    </button>
                </li>
            </ul>

            <div class="tab-content">

                <!-- Enter gameId -->
                <div class="tab-pane fade show active" id="tab-enter" role="tabpanel">
                    <form method="get" action="/nba/game" class="row g-3 align-items-end" id="nbaForm">
                        <div class="col-md-5">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span>NBA gameId</span>
                                <a href="/gameids.html" target="_blank" class="small text-decoration-none">
                                    Find Game IDs
                                </a>
                            </label>
                            <input class="form-control" name="gameId" placeholder="0022400247" required>
                            <div class="form-text">
                                Example: <span class="mono">0022400247</span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Clutch Window</label>
                            <select class="form-select" name="clutchSeconds" id="nbaClutchSelect">
                                <option value="300" selected>Last 5:00</option>
                                <option value="120">Last 2:00</option>
                                <option value="custom">Custom…</option>
                            </select>
                        </div>

                        <div class="col-md-3" id="nbaCustomWrap" style="display:none;">
                            <label class="form-label fw-semibold">Custom (sec)</label>
                            <input type="number" class="form-control" id="nbaCustomSeconds" min="1" max="720" placeholder="e.g. 180">
                            <div class="form-text">1–720 seconds</div>
                        </div>

                        <div class="col-12">
                            <button class="btn btn-success w-100" id="nbaSubmitBtn">Fetch & Analyze</button>
                        </div>
                    </form>
                </div>

                <!-- Recent games -->
                <div class="tab-pane fade" id="tab-recent" role="tabpanel">

                    <div class="d-flex flex-column flex-md-row gap-2 align-items-stretch align-items-md-end mb-3">
                        <div class="flex-grow-1">
                            <label class="form-label fw-semibold">Search</label>
                            <input class="form-control" id="recentSearch" placeholder="Filter by team (BOS), date, or gameId...">
                        </div>

                        <div class="d-grid" style="min-width: 160px;">
                            <button class="btn btn-outline-light" type="button" id="recentReloadBtn">Reload</button>
                        </div>
                    </div>

                    <div class="text-muted small mb-2" id="recentStatus">Click “Recent (Top 50)” to load.</div>

                    <div class="table-responsive">
                        <table class="table table-dark table-hover align-middle mb-0" style="--bs-table-bg: transparent;">
                            <thead>
                            <tr class="text-muted small">
                                <th>Date</th>
                                <th>Matchup</th>
                                <th class="d-none d-md-table-cell">GameId</th>
                                <th style="width: 140px;"></th>
                            </tr>
                            </thead>
                            <tbody id="recentTbody"></tbody>
                        </table>
                    </div>

                    <div class="text-muted small mt-2">
                        Shows the <strong>most recent 50 games</strong>, newest to oldest.
                        Uses your clutch window from the <strong>Enter gameId</strong> tab.
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap JS (needed for tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function wireCustom(selectId, wrapId, inputId) {
        const sel = document.getElementById(selectId);
        const wrap = document.getElementById(wrapId);
        const input = document.getElementById(inputId);

        function onChange() {
            const isCustom = sel.value === "custom";
            wrap.style.display = isCustom ? "block" : "none";
            if (!isCustom) input.value = "";
        }

        sel.addEventListener("change", onChange);

        sel.form.addEventListener("submit", function (e) {
            if (sel.value !== "custom") return;

            const v = parseInt(input.value, 10);
            if (!v || v <= 0) {
                e.preventDefault();
                alert("Enter a valid custom clutch window in seconds (e.g., 180).");
                return;
            }

            // remove any previously injected custom options
            Array.from(sel.options).forEach(o => {
                if (o.dataset && o.dataset.injected === "true") sel.removeChild(o);
            });

            // inject a real option so browser submits it
            const opt = document.createElement("option");
            opt.value = String(v);
            opt.textContent = "Custom (" + v + "s)";
            opt.selected = true;
            opt.dataset.injected = "true";
            sel.appendChild(opt);
        });

        onChange();
    }

    wireCustom("csvClutchSelect", "csvCustomWrap", "csvCustomSeconds");
    wireCustom("nbaClutchSelect", "nbaCustomWrap", "nbaCustomSeconds");

    // ---------------------------
    // Recent Games (Top 50)
    // ---------------------------
    window.__recentGames = [];

    function renderRecentGames(filterText) {
        const tbody = document.getElementById("recentTbody");
        const status = document.getElementById("recentStatus");
        const q = (filterText || "").trim().toLowerCase();

        const games = (window.__recentGames || []);
        const filtered = games.filter(g => {
            const hay = `${g.date} ${g.away} ${g.home} ${g.gameId}`.toLowerCase();
            return !q || hay.includes(q);
        });

        tbody.innerHTML = "";

        if (games.length === 0) {
            status.textContent = "No recent games loaded yet.";
            return;
        }

        if (filtered.length === 0) {
            status.textContent = "No games match your search.";
            return;
        }

        status.textContent = `Showing ${filtered.length} of ${games.length} games (Top 50).`;

        const clutchSel = document.getElementById("nbaClutchSelect");
        const clutchCustom = document.getElementById("nbaCustomSeconds");

        function resolveClutchSeconds() {
            if (!clutchSel) return 300;
            if (clutchSel.value !== "custom") return parseInt(clutchSel.value, 10) || 300;
            const v = parseInt((clutchCustom && clutchCustom.value) || "", 10);
            return v > 0 ? v : 300;
        }

        for (const g of filtered) {
            const clutchSeconds = resolveClutchSeconds();
            const url = `/nba/game?gameId=${encodeURIComponent(g.gameId)}&clutchSeconds=${encodeURIComponent(clutchSeconds)}`;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="mono">${g.date}</td>
                <td><strong>${g.away}</strong> @ <strong>${g.home}</strong></td>
                <td class="d-none d-md-table-cell mono text-muted">${g.gameId}</td>
                <td class="text-end">
                    <a class="btn btn-sm btn-accent" href="${url}">Analyze</a>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    async function loadRecentGamesTop50() {
        const status = document.getElementById("recentStatus");
        const tbody = document.getElementById("recentTbody");

        status.textContent = "Loading Top 50…";
        tbody.innerHTML = "";

        try {
            const res = await fetch("/nba/recent?limit=50");
            if (!res.ok) throw new Error("HTTP " + res.status);

            const games = await res.json();
            window.__recentGames = Array.isArray(games) ? games : [];

            renderRecentGames(document.getElementById("recentSearch").value);
        } catch (e) {
            status.textContent = "Could not load recent games. Make sure /nba/recent works, then refresh.";
            window.__recentGames = [];
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const search = document.getElementById("recentSearch");
        const reload = document.getElementById("recentReloadBtn");
        const recentTabBtn = document.getElementById("tab-recent-btn");

        if (search) {
            search.addEventListener("input", () => {
                renderRecentGames(search.value);
            });
        }

        if (reload) {
            reload.addEventListener("click", () => {
                loadRecentGamesTop50();
            });
        }

        if (recentTabBtn) {
            recentTabBtn.addEventListener("click", () => {
                if (!window.__recentGames || window.__recentGames.length === 0) {
                    loadRecentGamesTop50();
                } else {
                    renderRecentGames(search.value);
                }
            });

            recentTabBtn.addEventListener("shown.bs.tab", () => {
                if (!window.__recentGames || window.__recentGames.length === 0) {
                    loadRecentGamesTop50();
                } else {
                    renderRecentGames(search.value);
                }
            });
        }
    });
</script>
</body>
</html>
